<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>plAint 1.0.27 - Typo Fix</title> <style>
        /* --- Styles unchanged --- */
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 1em; background-color: #e8f5e9; margin-top: 120px; margin-bottom: 50px; }
        button { cursor: pointer; border: none; border-radius: 5px;}
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        * { box-sizing: border-box; }
        :root { --bg-main: #e8f5e9; --text-main: #333; --text-light: #555; --panel-bg: #f9f9f9; --plant-bg: #fff; --border-light: #eee; --border-medium: #ddd; --border-dark: #ccc; --header-bg: #ffffffcc; --tab-bg: #f8f8f8cc; --tab-inactive: #e0e0e0; --tab-active-bg: #ffffff; --tab-active-border: #4CAF50; --money-color: #008000; --petal-color: #D81B60; --sell-petal-bg: #ff80ab; --sell-petal-active: #c51162; --buy-plant-bg: #4CAF50; --buy-plant-active: #367c39; --fertilize-bg: #8bc34a; --fertilize-active: #689f38; --fertilize-flash: #7cb342; --upgrade-bg: #2196F3; --upgrade-active: #1769aa; --upgrade-maxed: #9E9E9E; --locked-bg: #f0f0f0; --locked-button: #aaa; --prereq-color: #e91e63; }
        body.night-mode { --bg-main: #263238; --text-main: #ECEFF1; --text-light: #B0BEC5; --panel-bg: #37474F; --plant-bg: #455A64; --border-light: #546E7A; --border-medium: #607D8B; --border-dark: #78909C; --header-bg: #212121cc; --tab-bg: #303030cc; --tab-inactive: #616161; --tab-active-bg: #424242; --tab-active-border: #81C784; --money-color: #A5D6A7; --petal-color: #F48FB1; --sell-petal-bg: #AD1457; --sell-petal-active: #880E4F; --buy-plant-bg: #388E3C; --buy-plant-active: #1B5E20; --fertilize-bg: #689F38; --fertilize-active: #33691E; --fertilize-flash: #558B2F; --upgrade-bg: #1976D2; --upgrade-active: #0D47A1; --upgrade-maxed: #757575; --locked-bg: #424242; --locked-button: #757575; --prereq-color: #F06292; }
        body { transition: background-color 0.3s, color 0.3s; }
        .resource-display { position: fixed; top: 0; left: 0; right: 0; background-color: var(--header-bg); backdrop-filter: blur(5px); padding: 10px; border-bottom: 1px solid var(--border-dark); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; width: 100%; text-align: center; font-size: 1.1em; font-weight: bold; transition: background-color 0.3s, border-bottom 0.3s; }
        .resource-display span { margin: 0 10px; display: inline-block; }
        .resource-display .money { color: var(--money-color); }
        .resource-display .petals { color: var(--petal-color); }
        #sell-petals-button { background-color: var(--sell-petal-bg); color: var(--text-main); padding: 5px 10px; font-size: 0.9em; vertical-align: middle; margin-left: 10px; }
        #sell-petals-button:active { background-color: var(--sell-petal-active); }
        #sell-petals-button:disabled { background-color: var(--locked-button); }
        #upgrade-tabs-container { position: fixed; top: 55px; left: 0; right: 0; background-color: var(--tab-bg); backdrop-filter: blur(3px); padding: 5px 0; z-index: 99; width: 100%; text-align: center; white-space: nowrap; overflow-x: auto; border-bottom: 1px solid var(--border-medium); transition: background-color 0.3s, border-bottom 0.3s; }
        .upgrade-tab-button { padding: 8px 12px; margin: 0 3px; font-size: 0.9em; background-color: var(--tab-inactive); color: var(--text-main); border-bottom: 3px solid transparent; transition: background-color 0.2s, border-bottom 0.2s, color 0.3s; }
        .upgrade-tab-button.active { background-color: var(--tab-active-bg); border-bottom-color: var(--tab-active-border); font-weight: bold; }
        #upgrade-panel-container { width: 95%; max-width: 600px; margin-bottom: 1em; min-height: 250px; background-color: var(--panel-bg); border: 1px solid var(--border-medium); border-radius: 8px; padding: 15px; transition: background-color 0.3s, border 0.3s; }
        .upgrade-panel { display: none; animation: fadeIn 0.3s ease-in-out; }
        .upgrade-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .upgrade-panel h3 { margin-top: 0; margin-bottom: 15px; text-align: center; color: var(--text-main); transition: color 0.3s; }
        .panel-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-medium); transition: border-bottom 0.3s; }
        .panel-section:last-child { border-bottom: none; margin-bottom: 0; }
        .panel-section h4 { margin-top: 0; margin-bottom: 10px; text-align: center; color: var(--text-light); font-size: 1.1em; transition: color 0.3s; }
        .panel-action { text-align: center; }
        .panel-action .fertilize-button { background-color: var(--fertilize-bg); color: white; padding: 12px 25px; font-size: 1.1em; width: auto; min-width: 150px; transition: background-color 0.1s ease-out, transform 0.1s ease-out; }
        .panel-action .fertilize-button:active:not(.fertilize-active) { background-color: var(--fertilize-active); transform: scale(0.98); }
        .panel-action .fertilize-button.fertilize-active { background-color: var(--fertilize-flash); transform: scale(0.96); }
        .upgrade-tree { display: flex; flex-direction: column; gap: 10px; }
        .upgrade-item { display: flex; align-items: center; justify-content: space-between; background-color: var(--plant-bg); border: 1px solid var(--border-light); border-radius: 5px; padding: 10px; gap: 10px; transition: background-color 0.3s, border 0.3s; }
        .upgrade-info { flex-grow: 1; }
        .upgrade-info span { display: block; font-size: 0.9em; margin-bottom: 2px; }
        .upgrade-name { font-weight: bold; margin-bottom: 3px; font-size: 1em; color: var(--text-main); }
        .upgrade-desc { color: var(--text-light); margin-bottom: 5px; }
        .upgrade-level { color: var(--text-main); }
        .upgrade-cost { font-weight: bold; color: var(--money-color); }
        .upgrade-item .upgrade-buy-button { background-color: var(--upgrade-bg); color: white; padding: 8px 12px; font-size: 0.9em; flex-shrink: 0; min-width: 80px; text-align: center; }
        .upgrade-item .upgrade-buy-button.maxed { background-color: var(--upgrade-maxed); cursor: default; }
        .upgrade-item .upgrade-buy-button:active:not(:disabled):not(.maxed) { background-color: var(--upgrade-active); }
        .stats-section { text-align: center; font-size: 0.95em; }
        .stats-section span { display: block; margin-bottom: 5px; color: var(--text-main); }
        .stats-section .stat-value { font-weight: bold; color: var(--text-main); }
        #plant-list { width: 95%; max-width: 600px; display: flex; flex-direction: column; gap: 15px; }
        .plant-generator { background-color: var(--plant-bg); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 15px; display: grid; grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; grid-template-areas: "header" "stats" "controls"; gap: 5px 15px; opacity: 1; transition: opacity 0.5s ease-in-out, background-color 0.3s; min-height: 240px; }
        .plant-generator.locked { opacity: 0.6; background-color: var(--locked-bg); }
        .plant-generator.locked .buy-plant-button { background-color: var(--locked-button); }
        .plant-header { grid-area: header; text-align: center; padding-bottom: 5px; margin-bottom: 10px; border-bottom: 1px solid var(--border-light); }
        .plant-name { font-size: 1.4em; font-weight: bold; margin-bottom: 4px; color: var(--text-main); }
        .plant-stats { font-size: 0.9em; color: var(--text-light); }
        .plant-stats span { display: inline-block; margin: 0 8px;}
        .plant-controls { grid-area: controls; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; min-width: 150px; padding-top: 130px; min-height: 200px; }
        .button-row { display: flex; width: 90%; margin: 0 auto; gap: 8px; align-items: stretch; position: relative; z-index: 5; margin-top: auto; }
        .buy-plant-button { padding: 15px 10px; font-size: 1.0em; background-color: var(--buy-plant-bg); color: white; flex-grow: 1; text-align: center; min-width: 100px; }
        .buy-plant-button:active:not(:disabled) { background-color: var(--buy-plant-active); }
        .fertilize-side-button { padding: 5px; font-size: 0.75em; line-height: 1.1; background-color: var(--fertilize-bg); color: white; z-index: 6; flex-shrink: 0; aspect-ratio: 1 / 1; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; min-height: 40px; transition: background-color 0.1s ease-out, transform 0.1s ease-out; }
        .fertilize-side-button span { font-size: 0.9em; display: block; }
        .fertilize-side-button:active:not(.fertilize-active) { background-color: var(--fertilize-active); transform: scale(0.95); }
        .fertilize-side-button.fertilize-active { background-color: var(--fertilize-flash); transform: scale(0.92); }
        .plant-visual-container { position: absolute; bottom: 55px; left: 0; right: 0; margin: 0 auto; width: 90%; height: 170px; z-index: 4; pointer-events: none; display: flex; justify-content: center; align-items: flex-end; gap: 2px; overflow: hidden; }
        .plant-instance { position: relative; height: 100%; flex-shrink: 0; display: flex; justify-content: center; align-items: flex-end; }
        .plant-instance.small { width: 12px; } .plant-instance.large { width: 20px; }
        .plant-stem { height: 0px; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); border-radius: 3px 3px 0 0; transition: height 0.2s ease-out; z-index: 0; transform-origin: bottom center; background-color: inherit; }
        .plant-leaf { position: absolute; left: 50%; opacity: 0; transform-origin: bottom center; transform: translateX(-50%) translateY(0px) rotate(0deg) scale(0); transition: opacity 0.3s ease-in, transform 0.3s ease-out, bottom 0.2s ease-out; z-index: 6; background-color: inherit; border-radius: inherit; }
        .plant-leaf.small { width: 10px; height: 14px; } .plant-leaf.large { width: 18px; height: 24px; }
        .plant-leaf.leaf-1 { transform: translateX(-50%) translateY(0px) rotate(-40deg) scale(0); } .plant-leaf.leaf-2 { transform: translateX(-50%) translateY(0px) rotate(40deg) scale(0); }
        .plant-leaf.leaf-3 { transform: translateX(-50%) translateY(0px) rotate(-75deg) scale(0); } .plant-leaf.leaf-4 { transform: translateX(-50%) translateY(0px) rotate(75deg) scale(0); }
        .plant-flower { position: absolute; left: 50%; border-radius: 50%; opacity: 0; transform: translateX(-50%) scale(0); transform-origin: center center; transition: bottom 0.2s ease-out, opacity 1.0s ease-in, transform 1.0s ease-out, width 0.6s linear, height 0.6s linear; z-index: 3; border: 1px solid rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; background-color: inherit; width: inherit; height: inherit; border-radius: inherit; }
        .flower-center { width: 40%; height: 40%; border-radius: 50%; border: 1px solid rgba(0,0,0,0.3); background-color: inherit; }
        .bee-visual { font-size: 18px; position: relative; animation: buzz-around 3.5s ease-in-out infinite alternate; padding: 0 2px; }
        @keyframes buzz-around { 0% { transform: translateX(-3px) translateY(0px) rotate(-8deg); } 25% { transform: translateX(3px) translateY(-4px) rotate(5deg); } 50% { transform: translateX(-2px) translateY(-2px) rotate(-3deg); } 75% { transform: translateX(2px) translateY(-5px) rotate(8deg); } 100% { transform: translateX(-3px) translateY(-1px) rotate(-5deg); } }
        @media (max-width: 550px) { .plant-generator { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; grid-template-areas: "header" "stats" "controls"; align-items: center; gap: 10px; min-height: 240px; } .plant-header { width: 100%; margin-bottom: 0; } .plant-name { font-size: 1.2em; } .plant-stats { text-align: center; padding-bottom: 5px;} .plant-controls { width: 100%; min-width: unset; padding-top: 100px; } .plant-visual-container { bottom: 60px; height: 140px; width: 90%; } .button-row { width: 90%; gap: 5px; } .plant-instance.small { width: 10px; } .plant-instance.large { width: 18px; } .plant-stem.small { width: 4px; } .plant-stem.large { width: 6px; } .plant-leaf.small { width: 8px; height: 11px; bottom: 2px;} .plant-leaf.large { width: 12px; height: 16px;} .buy-plant-button { padding: 12px 10px; font-size: 0.9em; } .fertilize-side-button { font-size: 0.7em; padding: 4px;} .bee-visual { font-size: 14px; }}
        #upgrade-panel-settings .settings-section { text-align: left; padding: 10px; }
        #upgrade-panel-settings label { display: inline-block; margin-right: 10px; min-width: 100px;}
        #upgrade-panel-settings button { margin-left: 10px; padding: 5px 10px; background-color: var(--upgrade-bg); color: white; }
         #upgrade-panel-settings button:active { background-color: var(--upgrade-active); }

    </style>
</head>
<body>
    <div class="resource-display"> <span class="petals">Petals: <span id="petal-count">0</span></span> <span class="money">Money: $ <span id="money-count">0</span></span> <button id="sell-petals-button" disabled>Sell Petals ($ <span id="petal-sell-price">0.50</span> ea)</button> </div>
    <div id="upgrade-tabs-container"></div>
    <div id="upgrade-panel-container">
        <div class="upgrade-panel" id="upgrade-panel-gardener"></div>
        <div class="upgrade-panel" id="upgrade-panel-bees"></div>
        <div class="upgrade-panel" id="upgrade-panel-settings"></div>
    </div>
    <div id="plant-list"></div>

    <script>
        // --- Game State Variables ---
        let petals = 0; let money = 5; const BASE_PETAL_SELL_PRICE = 0.5;
        let effectivePetalSellPrice = BASE_PETAL_SELL_PRICE;
        const GAME_LOOP_INTERVAL_MS = 100; let activeUpgradeTabId = null;
        const MAX_LARGE_PLANT_VISUALS = 5; const SMALL_PLANTS_PER_LARGE = 10; const FLOWER_GROWTH_EXPONENT = 4.2;
        const LEAF_GROWTH_EXPONENT = 1.5;
        let fertilizeIntervalId = null; const FERTILIZE_INTERVAL_MS = 120;
        const BEE_CHECK_INTERVAL_MS = 90000; const BASE_BEE_CHANCE = 0.10;
        let isNightMode = false;

        // --- State Objects ---
        let gardener = { upgrades: { petalPrice: { id: 'petalPrice', name: 'Better Sales Tactics', description: 'Increase Petal sell price.', level: 0, maxLevel: 25, cost: 500, costMultiplier: 1.8, effectValue: 0.05 } } };
        let bees = { unlocked: false, upgrades: { triggerChance: { id: 'triggerChance', name: 'Bee Motivation', description: 'Increase auto-fertilize chance.', level: 0, maxLevel: 15, cost: 1000, costMultiplier: 1.7, effectValue: 0.01 }, } };
        let plantTypes = [ { id: 'basic_green', name: 'Basic Green', beeCount: 0, costToUnlock: 0, baseCostToBuyOne: 5, costMultiplier: 1.08, baseGrowthTime: 8, basePetalProduction: 1, baseManualGrowthBoost: 0.15, owned: 1, growthProgress: 0, isUnlocked: true, visuals: { stemColor: '#228b22', stemWidth: 4, largeStemWidth: 6, leafColor: '#32cd32', leafShape: '50% 0', leafScale: 1.8, leafBaseY: 2, flowerColor: '#ffffff', flowerCenterColor: '#ffeb3b', flowerShape: '50%', flowerSize: 38, largeFlowerSize: 55, minFlowerSize: 2, largeMinFlowerSize: 3, maxStemHeight: 70, largeMaxStemHeight: 80, largeLeafScale: 1.2, largeLeafBaseY: 3, }, domRefs: {}, upgrades: [ { id: 'bg_prod1', name: 'Better Soil', description: 'Increases base petals.', cost: 15, costMultiplier: 1.7, level: 0, maxLevel: 10, effect: { target: 'basePetalProduction', type: 'add', value: 1 } }, { id: 'bg_speed1', name: 'Faster Sprouts', description: 'Reduces growth time.', cost: 25, costMultiplier: 1.8, level: 0, maxLevel: 10, effect: { target: 'growthTime', type: 'multiply', value: 0.92 } }, { id: 'bg_boost1', name: 'Potent Fertilizer', description: 'Improves manual fertilize boost.', cost: 40, costMultiplier: 2.0, level: 0, maxLevel: 5, effect: { target: 'manualGrowthBoost', type: 'add', value: 0.05 } }, { id: 'bg_prod2', name: 'Genetic Boost', description: 'Multiplies petals.', requires: ['bg_prod1', 3], cost: 300, costMultiplier: 2.5, level: 0, maxLevel: 5, effect: { target: 'petalMultiplier', type: 'multiply', value: 1.5 } }, ] }, { id: 'ruby_red', name: 'Ruby Red', beeCount: 0, costToUnlock: 80, baseCostToBuyOne: 40, costMultiplier: 1.12, baseGrowthTime: 14, basePetalProduction: 5, baseManualGrowthBoost: 0.1, owned: 0, growthProgress: 0, isUnlocked: false, visuals: { stemColor: '#8B0000', stemWidth: 5, largeStemWidth: 7, leafColor: '#FF4500', leafShape: '0 50%', leafScale: 1.9, leafBaseY: 3, flowerColor: '#dc143c', flowerCenterColor: '#440000', flowerShape: '10% 50%', flowerSize: 40, largeFlowerSize: 58, minFlowerSize: 3, largeMinFlowerSize: 4, maxStemHeight: 85, largeMaxStemHeight: 95, largeLeafScale: 1.3, largeLeafBaseY: 5, }, domRefs: {}, upgrades: [ { id: 'rr_prod1', name: 'Rich Compost', description: 'Increases base petals.', cost: 100, costMultiplier: 1.8, level: 0, maxLevel: 8, effect: { target: 'basePetalProduction', type: 'add', value: 4 } }, { id: 'rr_speed1', name: 'Quickening Roots', description: 'Greatly reduces growth time.', cost: 180, costMultiplier: 1.9, level: 0, maxLevel: 8, effect: { target: 'growthTime', type: 'multiply', value: 0.90 } }, ] }, { id: 'sunny_yellow', name: 'Sunny Yellow', beeCount: 0, costToUnlock: 1000, baseCostToBuyOne: 500, costMultiplier: 1.14, baseGrowthTime: 25, basePetalProduction: 25, baseManualGrowthBoost: 0.08, owned: 0, growthProgress: 0, isUnlocked: false, visuals: { stemColor: '#DAA520', stemWidth: 3, largeStemWidth: 5, leafColor: '#FFD700', leafShape: '50% 50% 0 0', leafScale: 1.7, leafBaseY: 2, flowerColor: '#ffeb3b', flowerCenterColor: '#ffa000', flowerShape: '40% 10%', flowerSize: 38, largeFlowerSize: 56, minFlowerSize: 3, largeMinFlowerSize: 4, maxStemHeight: 75, largeMaxStemHeight: 85, largeLeafScale: 1.1, largeLeafBaseY: 4, }, domRefs: {}, upgrades: [ { id: 'sy_prod1', name: 'Photosynthesis Boost', description: 'Increases base petals.', cost: 800, costMultiplier: 1.9, level: 0, maxLevel: 10, effect: { target: 'basePetalProduction', type: 'add', value: 15 } }, { id: 'sy_speed1', name: 'Solar Flare Growth', description: 'Rapidly decreases growth time.', cost: 1200, costMultiplier: 2.0, level: 0, maxLevel: 10, effect: { target: 'growthTime', type: 'multiply', value: 0.92 } }, { id: 'sy_auto1', name: 'Automated Harvesting', description: 'Generates passive money/sec.', cost: 5000, costMultiplier: 2.5, level: 0, maxLevel: 5, effect: { target: 'passiveIncome', type: 'add', value: 0.1 } }, ] }, { id: 'azure_blue', name: 'Azure Blue', beeCount: 0, costToUnlock: 10000, baseCostToBuyOne: 15000, costMultiplier: 1.18, baseGrowthTime: 35, basePetalProduction: 150, baseManualGrowthBoost: 0.06, owned: 0, growthProgress: 0, isUnlocked: false, visuals: { stemColor: '#007FFF', stemWidth: 4, largeStemWidth: 6, leafColor: '#87CEEB', leafShape: '25%', leafScale: 1.8, leafBaseY: 3, flowerColor: '#4682B4', flowerCenterColor: '#E0FFFF', flowerShape: '50% 0', flowerSize: 40, largeFlowerSize: 58, minFlowerSize: 3, largeMinFlowerSize: 5, maxStemHeight: 95, largeMaxStemHeight: 110, largeLeafScale: 1.2, largeLeafBaseY: 5, }, domRefs: {}, upgrades: [ { id: 'ab_prod1', name: 'Sky Nutrient', description: 'Increases base petals.', cost: 20000, costMultiplier: 1.9, level: 0, maxLevel: 10, effect: { target: 'basePetalProduction', type: 'add', value: 50 } }, { id: 'ab_speed1', name: 'Cloud Growth', description: 'Reduce growth time.', cost: 30000, costMultiplier: 2.0, level: 0, maxLevel: 10, effect: { target: 'growthTime', type: 'multiply', value: 0.91 } }, { id: 'ab_prod2', name: 'Deep Blue', description: 'Multiply petals.', requires: ['ab_prod1', 4], cost: 150000, costMultiplier: 2.6, level: 0, maxLevel: 5, effect: { target: 'petalMultiplier', type: 'multiply', value: 1.8 } }, ] }, { id: 'violet_velvet', name: 'Violet Velvet', beeCount: 0, costToUnlock: 90000, baseCostToBuyOne: 120000, costMultiplier: 1.16, baseGrowthTime: 50, basePetalProduction: 900, baseManualGrowthBoost: 0.05, owned: 0, growthProgress: 0, isUnlocked: false, visuals: { stemColor: '#4B0082', stemWidth: 5, largeStemWidth: 7, leafColor: '#EE82EE', leafShape: '50% 20%', leafScale: 2.0, leafBaseY: 4, flowerColor: '#9400D3', flowerCenterColor: '#FF00FF', flowerShape: '50%', flowerSize: 42, largeFlowerSize: 60, minFlowerSize: 4, largeMinFlowerSize: 6, maxStemHeight: 80, largeMaxStemHeight: 95, largeLeafScale: 1.3, largeLeafBaseY: 6, }, domRefs: {}, upgrades: [ { id: 'vv_prod1', name: 'Royal Soil', description: 'Increases base petals.', cost: 180000, costMultiplier: 2.0, level: 0, maxLevel: 10, effect: { target: 'basePetalProduction', type: 'add', value: 300 } }, { id: 'vv_speed1', name: 'Plush Growth', description: 'Reduce growth time.', cost: 250000, costMultiplier: 2.1, level: 0, maxLevel: 10, effect: { target: 'growthTime', type: 'multiply', value: 0.93 } }, { id: 'vv_boost1', name: 'Velvet Touch', description: 'Improve manual boost.', cost: 400000, costMultiplier: 2.4, level: 0, maxLevel: 5, effect: { target: 'manualGrowthBoost', type: 'add', value: 0.04 } }, ] }, { id: 'emerald_gem', name: 'Emerald Gem', beeCount: 0, costToUnlock: 750000, baseCostToBuyOne: 1000000, costMultiplier: 1.20, baseGrowthTime: 70, basePetalProduction: 5000, baseManualGrowthBoost: 0.04, owned: 0, growthProgress: 0, isUnlocked: false, visuals: { stemColor: '#006400', stemWidth: 4, largeStemWidth: 6, leafColor: '#2E8B57', leafShape: '10%', leafScale: 1.9, leafBaseY: 3, flowerColor: '#32CD32', flowerCenterColor: '#F5FFFA', flowerShape: '0 25%', flowerSize: 44, largeFlowerSize: 62, minFlowerSize: 4, largeMinFlowerSize: 7, maxStemHeight: 105, largeMaxStemHeight: 120, largeLeafScale: 1.3, largeLeafBaseY: 5, }, domRefs: {}, upgrades: [ { id: 'eg_prod1', name: 'Crystal Lattice', description: 'Increases base petals.', cost: 1500000, costMultiplier: 2.1, level: 0, maxLevel: 10, effect: { target: 'basePetalProduction', type: 'add', value: 1500 } }, { id: 'eg_speed1', name: 'Geode Growth', description: 'Reduce growth time.', cost: 2000000, costMultiplier: 2.2, level: 0, maxLevel: 10, effect: { target: 'growthTime', type: 'multiply', value: 0.94 } }, { id: 'eg_income1', name: 'Gemstone Aura', description: 'Generates passive money/sec.', cost: 4000000, costMultiplier: 2.6, level: 0, maxLevel: 5, effect: { target: 'passiveIncome', type: 'add', value: 1.5 } }, ] }, ];
        // --- DOM Element References ---
        let petalCountSpan, moneyCountSpan, sellPetalsButton, petalSellPriceSpan, plantListDiv, upgradeTabsContainer, upgradePanelContainer, gardenerPanel, beesPanel, settingsPanel;
        // --- Core Calculation Functions ---
        function getModifierValue(plant, targetStat, modifierType, baseValue = (modifierType === 'multiply' ? 1 : 0)) { let finalValue = baseValue; let sourceObject = plant; if (!plant) { if (targetStat === 'petalPrice') sourceObject = gardener; else if (targetStat === 'beeTriggerChance') sourceObject = bees; else return baseValue; } if (!sourceObject || !sourceObject.upgrades) return baseValue; let relevantUpgrades = Array.isArray(sourceObject.upgrades) ? sourceObject.upgrades : Object.values(sourceObject.upgrades); relevantUpgrades.forEach(upgrade => { if (upgrade.effect?.target === targetStat && upgrade.effect?.type === modifierType && upgrade.level > 0) { let prereqsMet = true; if (upgrade.requires && plant) { const reqUpgradeId = upgrade.requires[0]; const reqLevel = upgrade.requires[1]; const reqUpgrade = plant.upgrades.find(u => u.id === reqUpgradeId); if (!reqUpgrade || reqUpgrade.level < reqLevel) prereqsMet = false; } if (prereqsMet) { if (modifierType === 'multiply') { finalValue *= Math.pow(upgrade.effect.value, upgrade.level); } else if (modifierType === 'add') { finalValue += upgrade.effect.value * upgrade.level; } } } }); return finalValue; }
        function calculateBuyCost(plant) { return Math.ceil(plant.baseCostToBuyOne * Math.pow(plant.costMultiplier, plant.owned)); }
        function calculateGrowthTime(plant) { const timeMultiplier = getModifierValue(plant, 'growthTime', 'multiply', 1); const time = plant.baseGrowthTime * timeMultiplier; return Math.max(0.1, time); }
        function calculateEffectivePetalProduction(plant) { const baseProduction = plant.basePetalProduction + getModifierValue(plant, 'basePetalProduction', 'add', 0); const productionMultiplier = getModifierValue(plant, 'petalMultiplier', 'multiply', 1); return Math.max(0, baseProduction * productionMultiplier); }
        function calculateManualBoost(plant) { return plant.baseManualGrowthBoost + getModifierValue(plant, 'manualGrowthBoost', 'add', 0); }
        function calculatePassiveIncome(plant) { return getModifierValue(plant, 'passiveIncome', 'add', 0); }
        function calculateEffectivePetalSellPrice() { const upgrade = gardener.upgrades.petalPrice; let price = BASE_PETAL_SELL_PRICE; if (upgrade && upgrade.level > 0) { price += (upgrade.effectValue * upgrade.level); } return price; }
        function calculateEffectiveBeeChance() { const baseChance = BASE_BEE_CHANCE; const bonusChance = getModifierValue(null, 'beeTriggerChance', 'add', 0); return Math.min(1.0, baseChance + bonusChance); }

        // --- UI Creation Functions ---
        function addBeeVisual(plant) { if (!plant || !plant.domRefs.visualContainer) return; const beeWrapper = document.createElement('div'); beeWrapper.className = 'bee-visual'; beeWrapper.innerHTML = 'üêù'; beeWrapper.style.transform = `translateX(${(Math.random() - 0.5) * 20}px)`; // Slightly more random X
         beeWrapper.style.animationDelay = `${Math.random() * -3.5}s`; plant.domRefs.visualContainer.appendChild(beeWrapper); if (!plant.domRefs.visualInstances) plant.domRefs.visualInstances = []; plant.domRefs.visualInstances.push({ type: 'bee', wrapper: beeWrapper }); }
        function addPlantVisual(plant, sizeType = 'small') { if (!plant || !plant.domRefs.visualContainer || !plant.domRefs.visualInstances) return; const vis = plant.visuals; const isLarge = sizeType === 'large'; const stemWidth = isLarge ? (vis.largeStemWidth || vis.stemWidth) : vis.stemWidth; const minFlowerSize = isLarge ? (vis.largeMinFlowerSize || vis.minFlowerSize) : vis.minFlowerSize; const flowerShape = vis.flowerShape || '50%'; const visualOffset = Math.random(); const instanceWrapper = document.createElement('div'); instanceWrapper.className = `plant-instance ${sizeType}`; const stem = document.createElement('div'); stem.className = `plant-stem ${sizeType}`; stem.style.backgroundColor = vis.stemColor; stem.style.height = '0px'; stem.style.width = `${stemWidth}px`; const leaf1 = document.createElement('div'); leaf1.className = `plant-leaf leaf-1 ${sizeType}`; leaf1.style.backgroundColor = vis.leafColor; leaf1.style.borderRadius = vis.leafShape; const leaf2 = document.createElement('div'); leaf2.className = `plant-leaf leaf-2 ${sizeType}`; leaf2.style.backgroundColor = vis.leafColor; leaf2.style.borderRadius = vis.leafShape; let leaf3 = null, leaf4 = null; if (isLarge) { leaf3 = document.createElement('div'); leaf3.className = `plant-leaf leaf-3 ${sizeType}`; leaf3.style.backgroundColor = vis.leafColor; leaf3.style.borderRadius = vis.leafShape; leaf3.style.opacity = '0'; leaf4 = document.createElement('div'); leaf4.className = `plant-leaf leaf-4 ${sizeType}`; leaf4.style.backgroundColor = vis.leafColor; leaf4.style.borderRadius = vis.leafShape; leaf4.style.opacity = '0'; } const flower = document.createElement('div'); flower.className = `plant-flower ${sizeType}`; flower.style.backgroundColor = vis.flowerColor; flower.style.width = `${minFlowerSize}px`; flower.style.height = `${minFlowerSize}px`; flower.style.borderRadius = flowerShape; flower.style.opacity = '0'; flower.style.transform = 'translateX(-50%) scale(0)'; const flowerCenter = document.createElement('div'); flowerCenter.className = 'flower-center'; flowerCenter.style.backgroundColor = vis.flowerCenterColor; flower.appendChild(flowerCenter); instanceWrapper.appendChild(stem); instanceWrapper.appendChild(leaf1); instanceWrapper.appendChild(leaf2); if (leaf3) instanceWrapper.appendChild(leaf3); if (leaf4) instanceWrapper.appendChild(leaf4); instanceWrapper.appendChild(flower); plant.domRefs.visualContainer.appendChild(instanceWrapper); plant.domRefs.visualInstances.push({ type: sizeType, wrapper: instanceWrapper, stem: stem, leaf1: leaf1, leaf2: leaf2, leaf3: leaf3, leaf4: leaf4, flower: flower, visualOffset: visualOffset }); }
        function removeLastPlantVisual(plant) { if (!plant || !plant.domRefs.visualContainer || !plant.domRefs.visualInstances || plant.domRefs.visualInstances.length === 0) return; const lastInstanceRef = plant.domRefs.visualInstances.pop(); if (lastInstanceRef && lastInstanceRef.wrapper) { if (plant.domRefs.visualContainer.contains(lastInstanceRef.wrapper)) { plant.domRefs.visualContainer.removeChild(lastInstanceRef.wrapper); } } }
        function syncVisuals(plant) { if (!plant || !plant.domRefs.visualContainer || !plant.domRefs.visualInstances) return; const targetBees = plant.beeCount; const visualOwnedBase = plant.owned - (targetBees * SMALL_PLANTS_PER_LARGE * 5); const targetLarge = Math.min(Math.floor(visualOwnedBase / SMALL_PLANTS_PER_LARGE), MAX_LARGE_PLANT_VISUALS); const remainingOwnedForSmall = visualOwnedBase - (targetLarge * SMALL_PLANTS_PER_LARGE); const targetSmall = Math.min(remainingOwnedForSmall, SMALL_PLANTS_PER_LARGE - 1); while (plant.domRefs.visualInstances.length > 0) { removeLastPlantVisual(plant); } for (let i = 0; i < targetBees; i++) { addBeeVisual(plant); } for (let i = 0; i < targetLarge; i++) { addPlantVisual(plant, 'large'); } for (let i = 0; i < targetSmall; i++) { addPlantVisual(plant, 'small'); } }
        function createPlantHTML(plant) { if (!plantListDiv) { console.error("ERROR: plantListDiv not found!"); return; } const vis = plant.visuals; let buttonActionText = ''; let buttonCostText = ''; let isInitiallyDisabled = false; if (plant.isUnlocked) { const currentBuyCost = calculateBuyCost(plant); buttonActionText = 'Buy 1'; buttonCostText = `$ ${currentBuyCost}`; } else { buttonActionText = 'Unlock'; buttonCostText = `$ ${plant.costToUnlock}`; isInitiallyDisabled = true; } const plantDiv = document.createElement('div'); plantDiv.className = 'plant-generator'; plantDiv.id = `plant-${plant.id}`; if (!plant.isUnlocked) plantDiv.classList.add('locked'); const initialBoost = calculateManualBoost(plant) * 100; plantDiv.innerHTML = ` <div class="plant-header"> <div class="plant-name">${plant.name}</div> <div class="plant-stats"> <span>Owned: <span class="owned-count">${plant.owned}</span></span> </div> </div> <div class="plant-controls"> <div class="plant-visual-container"></div> <div class="button-row"> <button class="buy-plant-button" data-plant-id="${plant.id}" ${isInitiallyDisabled ? 'disabled' : ''}> <span class="button-action-text">${buttonActionText}</span> (<span class="button-cost-text">${buttonCostText}</span>) </button> <button class="fertilize-side-button" title="Manual Boost" ${plant.owned === 0 || !plant.isUnlocked ? 'disabled' : ''}> Boost <span class="fertilize-boost-amount">${initialBoost.toFixed(0)}%</span> </button> </div> </div>`; plantListDiv.appendChild(plantDiv); plant.domRefs = plant.domRefs || { upgrades: {} }; plant.domRefs.plantDiv = plantDiv; plant.domRefs.plantName = plantDiv.querySelector('.plant-name'); plant.domRefs.plantStats = plantDiv.querySelector('.plant-stats'); plant.domRefs.ownedCount = plantDiv.querySelector('.owned-count'); plant.domRefs.plantControls = plantDiv.querySelector('.plant-controls'); plant.domRefs.buyButton = plantDiv.querySelector('.buy-plant-button'); plant.domRefs.buttonActionText = plantDiv.querySelector('.button-action-text'); plant.domRefs.buttonCostText = plantDiv.querySelector('.button-cost-text'); plant.domRefs.visualContainer = plantDiv.querySelector('.plant-visual-container'); plant.domRefs.fertilizeSideButton = plantDiv.querySelector('.fertilize-side-button'); plant.domRefs.fertilizeBoostAmountSpan = plantDiv.querySelector('.fertilize-boost-amount'); plant.domRefs.visualInstances = []; plant.domRefs.buyButton.addEventListener('click', () => buyPlantUnit(plant.id)); const fertilizeBtn = plant.domRefs.fertilizeSideButton; if (fertilizeBtn) { const plantId = plant.id; const startFertilizing = (e) => { if (plant.owned === 0 || !plant.isUnlocked) return; if (e.type === 'touchstart') e.preventDefault(); if (fertilizeIntervalId === null) { fertilizePlant(plantId); fertilizeIntervalId = setInterval(() => fertilizePlant(plantId), FERTILIZE_INTERVAL_MS); } }; const stopFertilizing = () => { if (fertilizeIntervalId !== null) { clearInterval(fertilizeIntervalId); fertilizeIntervalId = null; } }; fertilizeBtn.addEventListener('mousedown', startFertilizing); fertilizeBtn.addEventListener('touchstart', startFertilizing, { passive: false }); fertilizeBtn.addEventListener('mouseup', stopFertilizing); fertilizeBtn.addEventListener('mouseleave', stopFertilizing); fertilizeBtn.addEventListener('touchend', stopFertilizing); fertilizeBtn.addEventListener('touchcancel', stopFertilizing); } syncVisuals(plant); }
        function createBeeTabIfNotExists() { if (!bees.unlocked || document.querySelector('.upgrade-tab-button[data-tab-id="bees"]')) return; if (!upgradeTabsContainer) return; const beesTabButton = document.createElement('button'); beesTabButton.className = 'upgrade-tab-button bees-tab'; beesTabButton.dataset.tabId = 'bees'; beesTabButton.textContent = 'Bees üêù'; upgradeTabsContainer.appendChild(beesTabButton); }
        function createUpgradeTabButton(plant) { if (!plant.isUnlocked || (plant.domRefs && plant.domRefs.tabButton)) return; if (!upgradeTabsContainer) return; const tabButton = document.createElement('button'); tabButton.className = 'upgrade-tab-button'; tabButton.dataset.tabId = plant.id; tabButton.textContent = plant.name; upgradeTabsContainer.appendChild(tabButton); plant.domRefs = plant.domRefs || { upgrades: {} }; plant.domRefs.tabButton = tabButton; if (activeUpgradeTabId === null && plant.isUnlocked) { setActiveTab(plant.id); } }
        function createUpgradePanel(plant) { if (!plant || (plant.domRefs && plant.domRefs.upgradePanel)) return; if (!upgradePanelContainer) return; plant.domRefs = plant.domRefs || {}; plant.domRefs.upgrades = plant.domRefs.upgrades || {}; const panelDiv = document.createElement('div'); panelDiv.className = 'upgrade-panel'; panelDiv.id = `upgrade-panel-${plant.id}`; panelDiv.dataset.tabId = plant.id; let panelHTML = `<h3>${plant.name}</h3>`; panelHTML += `<div class="panel-section stats-section"> <h4>Current Stats</h4> <span>Petals/sec: <span class="stat-value" id="stat-petal-rate-${plant.id}">0.00</span></span> <span>Growth Time: <span class="stat-value" id="stat-growth-time-${plant.id}">0.00</span>s</span> <span>Manual Boost: <span class="stat-value" id="stat-manual-boost-${plant.id}">0</span>%</span> </div>`; panelHTML += `<div class="panel-section upgrade-tree"><h4>Upgrades</h4>`; if (plant.upgrades && plant.upgrades.length > 0) { plant.upgrades.forEach(upgrade => { const isMaxed = upgrade.level >= upgrade.maxLevel; const costText = isMaxed ? 'MAX' : `$ ${upgrade.cost}`; const buttonText = isMaxed ? 'Maxed' : 'Buy'; let prereqText = ''; let prereqsMet = true; if (upgrade.requires) { const reqUpgradeId = upgrade.requires[0]; const reqLevel = upgrade.requires[1]; const reqUpgrade = plant.upgrades.find(u => u.id === reqUpgradeId); const reqUpgradeName = reqUpgrade ? reqUpgrade.name : 'Unknown Upgrade'; prereqText = `<span class="upgrade-prereq" style="font-size: 0.8em; color: #e91e63;">Requires: ${reqUpgradeName} (Lv ${reqLevel})</span>`; if (!reqUpgrade || reqUpgrade.level < reqLevel) prereqsMet = false; } const isVisible = prereqsMet; panelHTML += `<div class="upgrade-item ${!isVisible ? 'hidden' : ''}" id="upgrade-${plant.id}-${upgrade.id}" data-upgrade-id="${upgrade.id}" ${!isVisible ? 'style="display: none;"': ''}><div class="upgrade-info"><span class="upgrade-name">${upgrade.name}</span><span class="upgrade-desc">${upgrade.description}</span>${prereqText}<span class="upgrade-level">Level: <span class="level-value">${upgrade.level}</span> / ${upgrade.maxLevel}</span><span class="upgrade-cost">Cost: <span class="cost-value">${costText}</span></span></div><button class="upgrade-buy-button ${isMaxed ? 'maxed' : ''}" ${isMaxed || !isVisible ? 'disabled' : ''}>${buttonText}</button></div>`; }); } else { panelHTML += `<span>No upgrades available yet.</span>`; } panelHTML += `</div>`; panelDiv.innerHTML = panelHTML; upgradePanelContainer.appendChild(panelDiv); plant.domRefs.upgradePanel = panelDiv; plant.domRefs.statPetalRate = panelDiv.querySelector(`#stat-petal-rate-${plant.id}`); plant.domRefs.statGrowthTime = panelDiv.querySelector(`#stat-growth-time-${plant.id}`); plant.domRefs.statManualBoost = panelDiv.querySelector(`#stat-manual-boost-${plant.id}`); plant.upgrades.forEach(upgrade => { const upgradeDiv = panelDiv.querySelector(`#upgrade-${plant.id}-${upgrade.id}`); if (upgradeDiv) { const buyBtn = upgradeDiv.querySelector('.upgrade-buy-button'); plant.domRefs.upgrades[upgrade.id] = { div: upgradeDiv, levelValue: upgradeDiv.querySelector('.level-value'), costValue: upgradeDiv.querySelector('.cost-value'), buyButton: buyBtn, prereqSpan: upgradeDiv.querySelector('.upgrade-prereq') }; buyBtn?.addEventListener('click', () => buyUpgrade(plant.id, upgrade.id)); } else { console.warn(`Could not find upgrade element for ${plant.id} - ${upgrade.id}`); } }); }
        function createGardenerPanelContent() { if (!gardenerPanel) return; let panelHTML = `<h3>Gardener</h3>`; panelHTML += `<div class="panel-section upgrade-tree"><h4>Global Upgrades</h4>`; Object.values(gardener.upgrades).forEach(upgrade => { const isMaxed = upgrade.level >= upgrade.maxLevel; const costText = isMaxed ? 'MAX' : `$ ${upgrade.cost}`; const buttonText = isMaxed ? 'Maxed' : 'Buy'; panelHTML += `<div class="upgrade-item" id="upgrade-gardener-${upgrade.id}" data-upgrade-id="${upgrade.id}"><div class="upgrade-info"><span class="upgrade-name">${upgrade.name}</span><span class="upgrade-desc">${upgrade.description} (+${(upgrade.effectValue * 100).toFixed(1)}¬¢/petal/lvl)</span> <span class="upgrade-level">Level: <span class="level-value">${upgrade.level}</span> / ${upgrade.maxLevel}</span><span class="upgrade-cost">Cost: <span class="cost-value">${costText}</span></span></div><button class="upgrade-buy-button ${isMaxed ? 'maxed' : ''}" ${isMaxed ? 'disabled' : ''}>${buttonText}</button></div>`; }); panelHTML += `</div>`; gardenerPanel.innerHTML = panelHTML; Object.values(gardener.upgrades).forEach(upgrade => { const button = gardenerPanel.querySelector(`#upgrade-gardener-${upgrade.id} .upgrade-buy-button`); button?.addEventListener('click', () => buyGardenerUpgrade(upgrade.id)); }); updateGardenerPanelContent(); }
        function createBeePanelContent() { if (!beesPanel) return; let panelHTML = `<h3>Bees</h3>`; panelHTML += `<div class="panel-section upgrade-tree"><h4>Hive Upgrades</h4>`; Object.values(bees.upgrades).forEach(upgrade => { const isMaxed = upgrade.level >= upgrade.maxLevel; const costText = isMaxed ? 'MAX' : `$ ${upgrade.cost}`; const buttonText = isMaxed ? 'Maxed' : 'Buy'; panelHTML += `<div class="upgrade-item" id="upgrade-bees-${upgrade.id}" data-upgrade-id="${upgrade.id}"><div class="upgrade-info"><span class="upgrade-name">${upgrade.name}</span><span class="upgrade-desc">${upgrade.description} (+${upgrade.effectValue * 100}%/lvl)</span> <span class="upgrade-level">Level: <span class="level-value">${upgrade.level}</span> / ${upgrade.maxLevel}</span><span class="upgrade-cost">Cost: <span class="cost-value">${costText}</span></span></div><button class="upgrade-buy-button ${isMaxed ? 'maxed' : ''}" ${isMaxed ? 'disabled' : ''}>${buttonText}</button></div>`; }); panelHTML += `</div>`; beesPanel.innerHTML = panelHTML; Object.values(bees.upgrades).forEach(upgrade => { const button = beesPanel.querySelector(`#upgrade-bees-${upgrade.id} .upgrade-buy-button`); button?.addEventListener('click', () => buyBeeUpgrade(upgrade.id)); }); updateBeePanelContent(); }
        function createSettingsPanelContent() { if (!settingsPanel) return; let panelHTML = `<h3>Settings</h3>`; panelHTML += `<div class="panel-section settings-section"> <h4>Display</h4> <div> <label for="night-mode-toggle">Night Mode:</label> <button id="night-mode-toggle">${isNightMode ? 'ON' : 'OFF'}</button> </div> </div>`; settingsPanel.innerHTML = panelHTML; const toggleBtn = settingsPanel.querySelector('#night-mode-toggle'); toggleBtn?.addEventListener('click', toggleNightMode); updateSettingsPanelContent(); }

        // --- UI Update Functions ---
        function updateUpgradePanelContent(plant) { if (!plant || !plant.domRefs?.upgradePanel || !plant.domRefs.upgradePanel.classList.contains('active')) { return; } const effectiveGrowthTime = calculateGrowthTime(plant); const effectivePetals = calculateEffectivePetalProduction(plant); const petalsPerSecond = plant.owned > 0 ? (effectivePetals * plant.owned) / effectiveGrowthTime : 0; const manualBoostPercent = calculateManualBoost(plant) * 100; if(plant.domRefs.statPetalRate) plant.domRefs.statPetalRate.textContent = petalsPerSecond.toFixed(2); if(plant.domRefs.statGrowthTime) plant.domRefs.statGrowthTime.textContent = effectiveGrowthTime.toFixed(2); if(plant.domRefs.statManualBoost) plant.domRefs.statManualBoost.textContent = manualBoostPercent.toFixed(1); plant.upgrades.forEach(upgrade => { if (!plant.domRefs.upgrades || !plant.domRefs.upgrades[upgrade.id]) { return; } const refs = plant.domRefs.upgrades[upgrade.id]; if (!refs || !refs.div) return; let prereqsMet = true; if (upgrade.requires) { const reqUpgradeId = upgrade.requires[0]; const reqLevel = upgrade.requires[1]; const reqUpgrade = plant.upgrades.find(u => u.id === reqUpgradeId); if (!reqUpgrade || reqUpgrade.level < reqLevel) { prereqsMet = false; } } if (prereqsMet) { refs.div.style.display = ''; refs.div.classList.remove('hidden'); } else { refs.div.style.display = 'none'; refs.div.classList.add('hidden'); return; } const isMaxed = upgrade.level >= upgrade.maxLevel; const canAfford = money >= upgrade.cost; if (refs.levelValue) refs.levelValue.textContent = upgrade.level; if (refs.costValue) refs.costValue.textContent = isMaxed ? 'MAX' : `$ ${upgrade.cost}`; if (refs.buyButton) { refs.buyButton.disabled = isMaxed || !canAfford || !prereqsMet; refs.buyButton.textContent = isMaxed ? 'Maxed' : 'Buy'; if (isMaxed) { refs.buyButton.classList.add('maxed'); } else { refs.buyButton.classList.remove('maxed'); } } }); }
        function updateGardenerPanelContent() { if (!gardenerPanel || !gardenerPanel.classList.contains('active')) return; Object.values(gardener.upgrades).forEach(upgrade => { const upgradeDiv = gardenerPanel.querySelector(`#upgrade-gardener-${upgrade.id}`); if (!upgradeDiv) return; const levelValue = upgradeDiv.querySelector('.level-value'); const costValue = upgradeDiv.querySelector('.cost-value'); const buyButton = upgradeDiv.querySelector('.upgrade-buy-button'); const isMaxed = upgrade.level >= upgrade.maxLevel; const canAfford = money >= upgrade.cost; if (levelValue) levelValue.textContent = upgrade.level; if (costValue) costValue.textContent = isMaxed ? 'MAX' : `$ ${upgrade.cost}`; if (buyButton) { buyButton.disabled = isMaxed || !canAfford; buyButton.textContent = isMaxed ? 'Maxed' : 'Buy'; if (isMaxed) { buyButton.classList.add('maxed'); } else { buyButton.classList.remove('maxed'); } } }); effectivePetalSellPrice = calculateEffectivePetalSellPrice(); if (petalSellPriceSpan) petalSellPriceSpan.textContent = effectivePetalSellPrice.toFixed(2); }
        function updateBeePanelContent() { if (!beesPanel || !beesPanel.classList.contains('active')) return; Object.values(bees.upgrades).forEach(upgrade => { const upgradeDiv = beesPanel.querySelector(`#upgrade-bees-${upgrade.id}`); if (!upgradeDiv) return; const levelValue = upgradeDiv.querySelector('.level-value'); const costValue = upgradeDiv.querySelector('.cost-value'); const buyButton = upgradeDiv.querySelector('.upgrade-buy-button'); const isMaxed = upgrade.level >= upgrade.maxLevel; const canAfford = money >= upgrade.cost; if (levelValue) levelValue.textContent = upgrade.level; if (costValue) costValue.textContent = isMaxed ? 'MAX' : `$ ${upgrade.cost}`; if (buyButton) { buyButton.disabled = isMaxed || !canAfford; buyButton.textContent = isMaxed ? 'Maxed' : 'Buy'; if (isMaxed) { buyButton.classList.add('maxed'); } else { buyButton.classList.remove('maxed'); } } }); }
        function updateSettingsPanelContent() { if (!settingsPanel || !settingsPanel.classList.contains('active')) return; const toggleBtn = settingsPanel.querySelector('#night-mode-toggle'); if (toggleBtn) { toggleBtn.textContent = `Night Mode: ${isNightMode ? 'ON' : 'OFF'}`; } }
        function setActiveTab(tabId) { if (activeUpgradeTabId) { const oldButton = upgradeTabsContainer.querySelector(`[data-tab-id="${activeUpgradeTabId}"]`); oldButton?.classList.remove('active'); } upgradePanelContainer.querySelectorAll('.upgrade-panel').forEach(p => p.classList.remove('active')); const newButton = upgradeTabsContainer.querySelector(`[data-tab-id="${tabId}"]`); newButton?.classList.add('active'); activeUpgradeTabId = tabId; let panelToShow = null; if (tabId === 'gardener') panelToShow = gardenerPanel; else if (tabId === 'bees') panelToShow = beesPanel; else if (tabId === 'settings') panelToShow = settingsPanel; else { const plant = plantTypes.find(p => p.id === tabId); if (plant) { if (!plant.domRefs.upgradePanel) createUpgradePanel(plant); panelToShow = plant.domRefs.upgradePanel; } } if (panelToShow) { panelToShow.classList.add('active'); if (tabId === 'gardener') updateGardenerPanelContent(); else if (tabId === 'bees') updateBeePanelContent(); else if (tabId === 'settings') updateSettingsPanelContent(); else updateUpgradePanelContent(plantTypes.find(p => p.id === tabId)); } }
        function handleTabClick(event) { if (event.target.classList.contains('upgrade-tab-button') && event.target.dataset.tabId) { const tabId = event.target.dataset.tabId; setActiveTab(tabId); } }

        // --- Game Logic Actions ---
        function completeGrowthCycle(plant) { if (plant.owned > 0) { const petalYield = calculateEffectivePetalProduction(plant) * plant.owned; petals += petalYield; } }
        function sellPetals() { if (petals > 0) { const earnings = petals * effectivePetalSellPrice; money += earnings; petals = 0; } }
        function fertilizePlant(plantId) { const plant = plantTypes.find(p => p.id === plantId); if (!plant || !plant.isUnlocked || plant.owned <= 0) return; const boostAmount = calculateManualBoost(plant); plant.growthProgress += boostAmount; plant.growthProgress = Math.min(plant.growthProgress, 1.0); const buttonRef = plant.domRefs?.fertilizeSideButton; if (buttonRef && !buttonRef.classList.contains('fertilize-active')) { buttonRef.classList.add('fertilize-active'); setTimeout(() => { buttonRef.classList.remove('fertilize-active'); }, 120); } }
        function buyUpgrade(plantId, upgradeId) { const plant = plantTypes.find(p => p.id === plantId); if (!plant || !plant.isUnlocked) return; const upgrade = plant.upgrades.find(u => u.id === upgradeId); if (!upgrade) return; let prereqsMet = true; if (upgrade.requires) { const reqUpgradeId = upgrade.requires[0]; const reqLevel = upgrade.requires[1]; const reqUpgrade = plant.upgrades.find(u => u.id === reqUpgradeId); if (!reqUpgrade || reqUpgrade.level < reqLevel) { prereqsMet = false; } } const isMaxed = upgrade.level >= upgrade.maxLevel; const canAfford = money >= upgrade.cost; if (prereqsMet && !isMaxed && canAfford) { money -= upgrade.cost; upgrade.level++; upgrade.cost = Math.ceil(upgrade.cost * upgrade.costMultiplier); updateUpgradePanelContent(plant); } }
        function buyGardenerUpgrade(upgradeId) { const upgrade = gardener.upgrades[upgradeId]; if (!upgrade) return; const isMaxed = upgrade.level >= upgrade.maxLevel; const canAfford = money >= upgrade.cost; if (!isMaxed && canAfford) { money -= upgrade.cost; upgrade.level++; upgrade.cost = Math.ceil(upgrade.cost * upgrade.costMultiplier); updateGardenerPanelContent(); } }
        function buyBeeUpgrade(upgradeId) { const upgrade = bees.upgrades[upgradeId]; if (!upgrade) return; const isMaxed = upgrade.level >= upgrade.maxLevel; const canAfford = money >= upgrade.cost; if (!isMaxed && canAfford) { money -= upgrade.cost; upgrade.level++; upgrade.cost = Math.ceil(upgrade.cost * upgrade.costMultiplier); updateBeePanelContent(); } }
        function toggleNightMode() { isNightMode = !isNightMode; document.body.classList.toggle('night-mode', isNightMode); try { localStorage.setItem('plaintNightMode', isNightMode); } catch (e) { console.warn("Could not save night mode preference:", e); } updateSettingsPanelContent(); }
        function buyPlantUnit(plantId) { const plant = plantTypes.find(p => p.id === plantId); if (!plant || !plant.isUnlocked) return; const cost = calculateBuyCost(plant); if (isNaN(cost)) { console.error(`Calculated cost is NaN for ${plantId}!`); return; } if (money >= cost - 0.00001) { money -= cost; const oldOwned = plant.owned; plant.owned++; const plantsPerBee = SMALL_PLANTS_PER_LARGE * 5; const oldPotentialBees = Math.floor(oldOwned / plantsPerBee); const newPotentialBees = Math.floor(plant.owned / plantsPerBee); if (newPotentialBees > oldPotentialBees) { if (plant.beeCount < MAX_LARGE_PLANT_VISUALS) { plant.beeCount++; if (!bees.unlocked) { bees.unlocked = true; createBeeTabIfNotExists(); } } else { /* console.log(`Max large visuals reached, cannot convert to bee for ${plant.name}`); */ } } syncVisuals(plant); } }
        function triggerBeeFertilize() { const effectiveChance = calculateEffectiveBeeChance(); plantTypes.forEach(plant => { if (plant.isUnlocked && plant.beeCount > 0) { for (let i = 0; i < plant.beeCount; i++) { if (Math.random() < effectiveChance) { fertilizePlant(plant.id); break; } } } }); }

        // --- Game Loop & Initialization ---
        function gameLoop() { const deltaTime = GAME_LOOP_INTERVAL_MS / 1000; let totalPassiveIncome = 0; plantTypes.forEach(plant => { if (plant.isUnlocked && plant.owned > 0) { const plantPassiveIncome = calculatePassiveIncome(plant); totalPassiveIncome += plantPassiveIncome * plant.owned * deltaTime; } if (plant.owned > 0 && plant.isUnlocked) { const effectiveGrowthTime = calculateGrowthTime(plant); if (effectiveGrowthTime > 0) { plant.growthProgress += deltaTime / effectiveGrowthTime; } else { plant.growthProgress = 1.0; } if (plant.growthProgress >= 1.0) { let cyclesCompleted = Math.floor(plant.growthProgress); for (let i = 0; i < cyclesCompleted; i++) { completeGrowthCycle(plant); } plant.growthProgress %= 1.0; } } else if (plant.owned <= 0) { plant.growthProgress = 0; } }); money += totalPassiveIncome; updateDisplay(); }
        function initializeGame() {
            console.log("--- Initializing plAint 1.0.27 ---");
             try {
                 petalCountSpan = document.getElementById('petal-count'); moneyCountSpan = document.getElementById('money-count'); sellPetalsButton = document.getElementById('sell-petals-button'); petalSellPriceSpan = document.getElementById('petal-sell-price'); plantListDiv = document.getElementById('plant-list'); upgradeTabsContainer = document.getElementById('upgrade-tabs-container'); upgradePanelContainer = document.getElementById('upgrade-panel-container'); gardenerPanel = document.getElementById('upgrade-panel-gardener'); beesPanel = document.getElementById('upgrade-panel-bees'); settingsPanel = document.getElementById('upgrade-panel-settings');
                 if (!petalCountSpan || !moneyCountSpan || !sellPetalsButton || !petalSellPriceSpan || !plantListDiv || !upgradeTabsContainer || !upgradePanelContainer || !gardenerPanel || !beesPanel || !settingsPanel ) { let missing = []; if (!petalCountSpan) missing.push('petal-count'); if (!moneyCountSpan) missing.push('money-count'); if (!sellPetalsButton) missing.push('sell-petals-button'); if (!petalSellPriceSpan) missing.push('petal-sell-price'); if (!plantListDiv) missing.push('plant-list'); if (!upgradeTabsContainer) missing.push('upgrade-tabs-container'); if (!upgradePanelContainer) missing.push('upgrade-panel-container'); if (!gardenerPanel) missing.push('upgrade-panel-gardener'); if (!beesPanel) missing.push('upgrade-panel-bees'); if (!settingsPanel) missing.push('upgrade-panel-settings'); throw new Error(`Essential elements not found. Missing IDs: ${missing.join(', ')}`); }
                 try { const savedNightMode = localStorage.getItem('plaintNightMode'); if (savedNightMode === 'true') { isNightMode = true; document.body.classList.add('night-mode'); } else { isNightMode = false; document.body.classList.remove('night-mode'); } } catch(e) { console.warn("Could not load night mode preference", e); isNightMode = false;}
                 effectivePetalSellPrice = calculateEffectivePetalSellPrice(); petalSellPriceSpan.textContent = effectivePetalSellPrice.toFixed(2);
                 const gardenerTabButton = document.createElement('button'); gardenerTabButton.className = 'upgrade-tab-button gardener-tab'; gardenerTabButton.dataset.tabId = 'gardener'; gardenerTabButton.textContent = 'Gardener'; upgradeTabsContainer.appendChild(gardenerTabButton);
                 const settingsTabButton = document.createElement('button'); settingsTabButton.className = 'upgrade-tab-button settings-tab'; settingsTabButton.dataset.tabId = 'settings'; settingsTabButton.textContent = 'Settings'; upgradeTabsContainer.appendChild(settingsTabButton); // Add settings tab
                 createGardenerPanelContent(); createBeePanelContent(); createSettingsPanelContent();
                 plantTypes.forEach(plant => { createPlantHTML(plant); }); let firstUnlockedPlantId = null;
                 plantTypes.forEach(plant => { if (plant.isUnlocked) { createUpgradeTabButton(plant); if (!plant.domRefs.upgradePanel) createUpgradePanel(plant); if (firstUnlockedPlantId === null) firstUnlockedPlantId = plant.id; } });
                 createBeeTabIfNotExists(); // Check if bees unlocked (e.g. from save)
                 if (firstUnlockedPlantId) { setActiveTab(firstUnlockedPlantId); } else { setActiveTab('gardener'); }
                 upgradeTabsContainer.addEventListener('click', handleTabClick); sellPetalsButton.addEventListener('click', sellPetals);
                 updateDisplay(); setInterval(gameLoop, GAME_LOOP_INTERVAL_MS); setInterval(triggerBeeFertilize, BEE_CHECK_INTERVAL_MS);
                 console.log("--- Game initialization COMPLETE ---");
            } catch (error) { console.error("!!!!!!!!!! ERROR DURING INITIALIZATION !!!!!!!!!", error); const errorDiv = document.createElement('div'); errorDiv.style.cssText = 'color: red; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border: 2px solid red; z-index: 200; text-align: center;'; errorDiv.innerHTML = `<strong>Error during initialization:</strong><br>${error.message}<br>Check console for details.`; if (document.body) { document.body.appendChild(errorDiv); } else { alert(`Error during initialization: ${error.message}. Check console for details.`); } }
        }
        window.addEventListener('DOMContentLoaded', initializeGame);

        // MODIFIED: updateDisplay uses corrected flower position
        function updateDisplay() {
            if (!petalCountSpan || !moneyCountSpan || !sellPetalsButton) { return; }
            petalCountSpan.textContent = petals.toFixed(0);
            moneyCountSpan.textContent = money.toFixed(2);
            sellPetalsButton.disabled = petals <= 0;
            if(petalSellPriceSpan) petalSellPriceSpan.textContent = effectivePetalSellPrice.toFixed(2);

            let activePlantForPanelUpdate = null;
            let activePanelIsGardener = activeUpgradeTabId === 'gardener';
            let activePanelIsBees = activeUpgradeTabId === 'bees';
            let activePanelIsSettings = activeUpgradeTabId === 'settings';

            plantTypes.forEach(plant => {
                 if (!plant.domRefs?.plantDiv || !plant.domRefs?.visualInstances) { if(plant.isUnlocked) { createPlantHTML(plant); if (!plant.domRefs?.plantDiv) { return; } } else { return; } }
                 const buyButtonRef = plant.domRefs.buyButton; const actionTextRef = plant.domRefs.buttonActionText; const costTextRef = plant.domRefs.buttonCostText;
                 const fertilizeBtnRef = plant.domRefs.fertilizeSideButton;
                 const fertilizeAmountRef = plant.domRefs.fertilizeBoostAmountSpan;

                if (!plant.isUnlocked && money >= plant.costToUnlock) { plant.isUnlocked = true; plant.domRefs.plantDiv.classList.remove('locked'); buyButtonRef?.classList.remove('locked'); createUpgradeTabButton(plant); if (!plant.domRefs.upgradePanel) createUpgradePanel(plant); if (activeUpgradeTabId === null) { setActiveTab(plant.id); } }
                if (plant.isUnlocked) { const currentBuyCost = calculateBuyCost(plant); if(actionTextRef) actionTextRef.textContent = 'Buy 1'; if(costTextRef) costTextRef.textContent = `$ ${currentBuyCost}`; if(buyButtonRef) buyButtonRef.disabled = money < currentBuyCost - 0.00001; }
                 else { if(actionTextRef) actionTextRef.textContent = 'Unlock'; if(costTextRef) costTextRef.textContent = `$ ${plant.costToUnlock}`; if(buyButtonRef) buyButtonRef.disabled = true; }

                 if (plant.domRefs.ownedCount) plant.domRefs.ownedCount.textContent = plant.owned;
                 if(fertilizeAmountRef) { const manualBoostPercent = calculateManualBoost(plant) * 100; fertilizeAmountRef.textContent = `${manualBoostPercent.toFixed(0)}%`; }
                 if(fertilizeBtnRef) { fertilizeBtnRef.disabled = plant.owned === 0 || !plant.isUnlocked; }

                const mainProgress = plant.owned > 0 ? plant.growthProgress : 0;
                const vis = plant.visuals;

                 if (Array.isArray(plant.domRefs.visualInstances)) {
                    plant.domRefs.visualInstances.forEach(instanceRefs => {
                         if (instanceRefs.type === 'bee') return; // Skip bees
                         if (!instanceRefs || !instanceRefs.stem || !instanceRefs.leaf1 || !instanceRefs.leaf2 || !instanceRefs.flower) return;

                         const visualProgress = (mainProgress + instanceRefs.visualOffset) % 1.0;
                         const isLarge = instanceRefs.type === 'large';
                         const stemHeightProp = isLarge ? vis.largeMaxStemHeight : vis.maxStemHeight;
                         const leafScaleProp = isLarge ? (vis.largeLeafScale || vis.leafScale) : vis.leafScale;
                         const leafBaseYProp = isLarge ? (vis.largeLeafBaseY || vis.leafBaseY) : vis.leafBaseY;
                         const maxFlowerSize = isLarge ? (vis.largeFlowerSize || vis.flowerSize) : vis.flowerSize;
                         const minFlowerSize = isLarge ? (vis.largeMinFlowerSize || vis.minFlowerSize) : vis.minFlowerSize;

                         const stemRef = instanceRefs.stem; const leaf1Ref = instanceRefs.leaf1; const leaf2Ref = instanceRefs.leaf2;
                         const leaf3Ref = instanceRefs.leaf3; const leaf4Ref = instanceRefs.leaf4;
                         const flowerRef = instanceRefs.flower;

                        let stemVisualProgress = visualProgress; if (isLarge) { stemVisualProgress = Math.min(1.0, visualProgress * 1.4); }
                        const currentStemHeight = stemVisualProgress * stemHeightProp;
                        stemRef.style.height = currentStemHeight + 'px';

                        const leaf1stSetProgress = Math.min(1, Math.max(0, (visualProgress - 0.1) / 0.6)); const easedLeaf1Progress = Math.pow(leaf1stSetProgress, LEAF_GROWTH_EXPONENT); const leaf1stSetScale = easedLeaf1Progress * leafScaleProp; const leaf1stSetOpacity = leaf1stSetProgress > 0.01 ? 1 : 0; const leaf1stSetYOffset = leaf1stSetProgress * 5;
                        leaf1Ref.style.opacity = leaf1stSetOpacity; leaf1Ref.style.transform = `translateX(-50%) translateY(-${leaf1stSetYOffset}px) rotate(-45deg) scale(${leaf1stSetScale})`; leaf1Ref.style.bottom = `${leafBaseYProp}px`;
                        leaf2Ref.style.opacity = leaf1stSetOpacity; leaf2Ref.style.transform = `translateX(-50%) translateY(-${leaf1stSetYOffset}px) rotate(45deg) scale(${leaf1stSetScale})`; leaf2Ref.style.bottom = `${leafBaseYProp}px`;

                        if (leaf3Ref && leaf4Ref) { const leaf2ndSetProgress = Math.min(1, Math.max(0, (visualProgress - 0.7) / 0.3)); const easedLeaf2Progress = Math.pow(leaf2ndSetProgress, LEAF_GROWTH_EXPONENT); const leaf2ndSetScale = easedLeaf2Progress * leafScaleProp; const leaf2ndSetOpacity = leaf2ndSetProgress > 0.01 ? 1 : 0; const leaf2ndSetYOffset = leaf2ndSetProgress * 8; const leaf2ndSetBottom = (currentStemHeight * 0.55) + leafBaseYProp; leaf3Ref.style.opacity = leaf2ndSetOpacity; leaf3Ref.style.transform = `translateX(-50%) translateY(-${leaf2ndSetYOffset}px) rotate(-75deg) scale(${leaf2ndSetScale})`; leaf3Ref.style.bottom = `${leaf2ndSetBottom}px`; leaf4Ref.style.opacity = leaf2ndSetOpacity; leaf4Ref.style.transform = `translateX(-50%) translateY(-${leaf2ndSetYOffset}px) rotate(75deg) scale(${leaf2ndSetScale})`; leaf4Ref.style.bottom = `${leaf2ndSetBottom}px`; }

                        const flowerAppearThreshold = 0.30; // Start earlier
                        const flowerVisibilityProgress = Math.min(1, Math.max(0, (visualProgress - flowerAppearThreshold) / (1.0 - flowerAppearThreshold))); const flowerOpacity = flowerVisibilityProgress > 0.01 ? 1 : 0; const flowerDisplayScale = flowerVisibilityProgress;
                        const sizeCapProgress = 0.55; const cappedVisualProgressForSize = Math.min(visualProgress, sizeCapProgress); const flowerGrowthFactor = sizeCapProgress > 0 ? Math.pow(cappedVisualProgressForSize / sizeCapProgress, FLOWER_GROWTH_EXPONENT) : 0; const currentFlowerSize = minFlowerSize + (maxFlowerSize - minFlowerSize) * flowerGrowthFactor; const finalFlowerSize = Math.max(minFlowerSize, currentFlowerSize);
                        // Position flower center on top of current stem height
                        const flowerBottomPosition = currentStemHeight - (finalFlowerSize / 2);

                        flowerRef.style.opacity = flowerOpacity; flowerRef.style.width = `${finalFlowerSize}px`; flowerRef.style.height = `${finalFlowerSize}px`; flowerRef.style.transform = `translateX(-50%) scale(${flowerDisplayScale})`; flowerRef.style.bottom = flowerBottomPosition + 'px';
                    });
                }
                if (plant.id === activeUpgradeTabId) { activePlantForPanelUpdate = plant; }
            });

            if (activePanelIsGardener) { updateGardenerPanelContent(); }
            else if (activePanelIsBees) { updateBeePanelContent(); }
            else if (activePanelIsSettings) { updateSettingsPanelContent(); }
            else if (activePlantForPanelUpdate) { updateUpgradePanelContent(activePlantForPanelUpdate); }
        }

    </script>
</body>
</html>